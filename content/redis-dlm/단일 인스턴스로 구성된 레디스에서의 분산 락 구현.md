---
emoji: π”’
title: λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤μ—μ„μ λ¶„μ‚° λ½ κµ¬ν„
date: '2021-10-23 02:00:00'
author: μΏ ν‚¤
tags: redis
categories: Infra
---

## λ¶„μ‚°λ½μ΄λ€

**λ¶„μ‚° λ½**(**Distributed Lock**)μ€ μ—¬λ¬ ν”„λ΅μ„Έμ¤κ°€ μƒνΈ λ°°νƒ€μ μΌλ΅ κ³µμ λλ” μμ›μ„ λ‹¤λ¤„μ•Ό ν•λ” κ²½μ° μ μ©ν•κ² μ‚¬μ©λ©λ‹λ‹¤. ν•λ‚μ ν”„λ΅μ„Έμ¤ λ‚΄μ—μ„ μ—¬λ¬ μ¤λ λ“μ— λ€ν•΄μ„ λ½μ„ κ±Έμ–΄μ•Ό ν•λ‹¤λ©΄ μ–Έμ–΄μ—μ„ μ κ³µν•΄μ£Όλ” `Synchoronize` κΈ°λ¥μ΄λ‚ `Lock` λ“±μ„ ν™μ©ν•  μ μμ§€λ§ μ—¬λ¬ ν”„λ΅μ„Έμ¤ λλ” λ¬Όλ¦¬μ μΌλ΅ λ¶„λ¦¬λ μ„λ²„μ—μ„ Lockμ„ κ±Έμ–΄μ•Ό ν•λ‹¤λ©΄ μ΄λ° λ°©λ²•μ„ μ‚¬μ©ν•  μ μ—†μµλ‹λ‹¤. λ€μ‹  μ—¬λ¬ μ„λ²„ κ°„μ μ„Έμ… μ •λ³΄λ¥Ό κ³µμ ν•κΈ° μ„ν•΄μ„ `Redis`λ¥Ό μ‚¬μ©ν•λ” κ²ƒμ²λΌ λ¶„μ‚° λ½μ„ κµ¬ν„ν•κΈ° μ„ν•΄μ„ λ λ””μ¤λ¥Ό μ‚¬μ©ν•  μλ„ μμµλ‹λ‹¤.

μ‹¤μ λ΅ [λ λ””μ¤ κ³µμ‹ λ¬Έμ„](https://redis.io/topics/distlock#implementations)μ—μ„ λ λ””μ¤λ΅ **λ¶„μ‚° λ½ λ§¤λ‹μ €**(**DLM: Distributed Lock Manager**)λ¥Ό κµ¬ν„ν• λΌμ΄λΈλ¬λ¦¬λ“¤μ„ μ†κ°ν•κ³  μμµλ‹λ‹¤. λΌμ΄λΈλ¬λ¦¬λ§λ‹¤ μ΅°κΈμ”© λ‹¤λ¥Έ μ κ·Ό λ°©μ‹μ„ μ‚¬μ©ν•κ³  μμΌλ©° λ³µμ΅ν• κµ¬ν„ λ°©μ‹μ„ νƒν•λ” λ€μ‹  κ°„λ‹¨ν• μ ‘κ·Ό λ°©μ‹μ„ μ‚¬μ©ν•¨μΌλ΅μ¨ λ‚®μ€ λ³΄μ¦μ„ μ κ³µν•κΈ°λ„ ν•©λ‹λ‹¤.

![img](images/Image.jpg)



μ΄ κΈ€μ€ λ λ””μ¤ κ³µμ‹ λ¬Έμ„μ—μ„ μ„¤λ…ν•λ” λ‹¨μΌ μΈμ¤ν„΄μ¤μ—μ„μ λ¶„μ‚° λ½ κµ¬ν„ λ°©λ²•κ³Ό λ¬Έμ μ , κ·Έλ¦¬κ³  ν¨μ¨μ μΈ λ¶„μ‚° λ½ κµ¬ν„ λ°©λ²•μ— λ€ν•΄ μ΄μ•ΌκΈ°ν•΄λ³΄λ ¤ ν•©λ‹λ‹¤. λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λΉ„λ¶„μ‚° μ‹μ¤ν…μ—μ„μ λ¶„μ‚° λ½ μ•κ³ λ¦¬μ¦λ¶€ν„° μ΄λ¥Ό ν™μ©ν• λ¶„μ‚° μ‹μ¤ν…μ—μ„μ λ¶„μ‚° λ½ μ•κ³ λ¦¬μ¦ [Redlock](https://redis.io/topics/distlock#the-redlock-algorithm)μ„ μ†κ°ν•κ³  μμΌλ‹ μ΄ κΈ€κ³Ό ν•¨κ» μ‚΄ν΄λ³΄λ©΄ μΆ‹μ„ κ²ƒ κ°™μµλ‹λ‹¤.

## λ¶„μ‚° λ½μ μ†μ„±

μ°λ¦¬κ°€ κµ¬ν„ν•λ ¤λ” λ¶„μ‚° λ½μ€ μ•„λ μ„Έκ°€μ§€ μ†μ„±μ„ λ³΄μ¥ν•΄μ•Ό ν•©λ‹λ‹¤.

* Safety Property
* Liveness Property A
* Liveness Property B

**Safety Property**λ” νΉμ • μκ°„μ— ν• ν΄λΌμ΄μ–ΈνΈλ§ λ½μ„ νλ“ν•  μ μλ‹¤λ” **μƒνΈ λ°°μ μ„±**μ„ μλ―Έν•©λ‹λ‹¤. λ™μ‹μ— μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ νλ“ν•λ ¤ ν–μ„ λ• ν• κ° μ΄μƒμ ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ νλ“ν•λ” κ²ƒμ„ λ§‰μ•„μ•Ό ν•λ‹¤λ” κ°λ…μ…λ‹λ‹¤. λ½μ κΈ°λ³Έμ μΈ μ—­ν• μ΄λΌκ³  ν•  μ μμµλ‹λ‹¤.

**Liveness Property A**λ” λ§μ•½ λ½μ„ νλ“ν• ν΄λΌμ΄μ–ΈνΈμ— μ¥μ• κ°€ λ°μƒν•΄ μ •μƒμ μΌλ΅ λ½μ„ λ°λ‚©ν•μ§€ λ»ν–μ„ λ• μμ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈλ“¤μ΄ λ½μ„ νλ“ν•  μ μ—†λ” **λ°λ“λ½**μ΄ λ°μƒν•΄μ„λ” μ•λλ‹¤λ” κ²ƒμ„ μλ―Έν•©λ‹λ‹¤. λ½μ„ κ°€μ Έκ°€μ„ μ¤λ«λ™μ• λ°λ‚©ν•μ§€ μ•μ„ λ• λ½μ„ κ°€μ Έκ°„ ν΄λΌμ΄μ–ΈνΈκ°€ μ •μƒμ μΌλ΅ λ½μ„ λ°λ‚©ν•  μ μ—†λ‹¤κ³  νλ‹¨ν•΄ λ½μ„ νμν•κ³  κΈ°λ‹¤λ¦¬κ³  μλ” λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ—κ² λ½μ„ μ κ³µν•  μ μμ–΄μ•Όν•λ‹¤λ” λ»μ…λ‹λ‹¤. λ§μ•½ μ΄λ° μ‚¬μ‹¤μ΄ λ³΄μ¥λμ§€ μ•λ”λ‹¤λ©΄ λ°λ“λ½μ΄ λ°μƒν–μ„ λ• λ½μ„ μ‚¬μ©ν•λ” λ¨λ“  μ”μ²­μ„ μ²λ¦¬ν•  μ μ—†κ²λκ³  κΈ°λ‹¤λ¦¬λ‹¤κ°€ νƒ€μ„ μ•„μ›ƒλ§ λ°μƒν•  μλ„ μμµλ‹λ‹¤.

**Liveness Property B**λ” μ—¬λ¬ λ λ””μ¤ λ…Έλ“κ°€ μ΅΄μ¬ν•λ” κ²½μ°, μΌλ¶€ λ…Έλ“μ— μ¥μ• κ°€ λ°μƒν•λ”λΌλ„ ν΄λΌμ΄μ–ΈνΈλ” μ •μƒμ μΌλ΅ λ½μ„ νλ“ν•κ³  λ°λ‚©ν•  μ μμ–΄μ•Ό ν•©λ‹λ‹¤. μ¦‰, μ–΄λ μ •λ„μ **κ²°ν•¨ ν—μ©μ„±**(**Fault Tolerance**)λ¥Ό μ§€λ…€μ•Ό ν•©λ‹λ‹¤.



## λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤μ—μ„μ λ¶„μ‚° λ½ κµ¬ν„

λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤λ¥Ό μ‚¬μ©ν•΄ λ¶„μ‚° λ½μ„ κµ¬ν„ν•λ” λ°©λ²•μ€ μ•„λμ™€ κ°™μµλ‹λ‹¤.

* λ½μ„ νλ“ν•  λ• ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤. λ§μ•½ ν‚¤κ°€ μ΄λ―Έ μ΅΄μ¬ν•λ‹¤λ©΄ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ μ΄λ―Έ λ½μ„ νλ“ν• κ²ƒμ΄λ―€λ΅ ν‚¤κ°€ μ‚­μ λ  λ•κΉμ§€ κΈ°λ‹¤λ¦½λ‹λ‹¤.
* λ½μ„ λ°λ‚©ν•λ©΄μ„ ν‚¤λ¥Ό μ‚­μ ν•©λ‹λ‹¤. ν‚¤κ°€ μ‚­μ λλ©΄ κΈ°λ‹¤λ¦¬κ³  μλ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈ μ¤‘ ν•λ‚κ°€ λ½μ„ νλ“ν•κ² λ©λ‹λ‹¤.

λ§μ•½ ν‚¤μ μ΅΄μ¬ μ—¬λ¶€λ¥Ό ν™•μΈν•κ³  ν‚¤λ¥Ό μƒμ„±ν•λ” μ—°μ‚°μ΄ `μ›μμ `μΌλ΅ μ΄λ£¨μ–΄μ§ μ μλ‹¤λ©΄ **Safety Property**λ¥Ό λ³΄μ¥ν•  μ μμµλ‹λ‹¤. ν•μ§€λ§ **Liveness Property A**μ™€ **Liveness Property B**λ” λ³΄μ¥ν•  μ μ—†μµλ‹λ‹¤. ν‚¤λ¥Ό νλ“ν• ν΄λΌμ΄μ–ΈνΈμ— μ¥μ• κ°€ λ°μƒν•΄ λ…μ‹μ μΌλ΅ ν‚¤λ¥Ό μ‚­μ ν•μ§€ λ»ν•΄ λ½μ€ (κ°λ…μ μΌλ΅)λ°λ‚© λμ—μ§€λ§ ν‚¤λ” μ—¬μ „ν λ‚¨μ•„μκΈ° λ•λ¬Έμ…λ‹λ‹¤.

λ λ””μ¤μ—μ„ μ κ³µν•λ” `EXPIRES` κΈ°λ¥μ„ μ‚¬μ©ν•λ©΄ **Liveness Property A**λ¥Ό λ³΄μ¥ν•  μ μμµλ‹λ‹¤. λ…μ‹μ μΌλ΅ ν‚¤λ¥Ό μ‚­μ ν•μ§€ λ»ν•΄λ„ μ‹κ°„μ΄ μ§€λ‚λ©΄ λ λ””μ¤κ°€ ν‚¤λ¥Ό μ‚­μ ν•΄μ£ΌκΈ° λ•λ¬Έμ…λ‹λ‹¤. ν•μ§€λ§ μ—¬μ „ν **Liveness Property B**λ” λ³΄μ¥ν•  μ μ—†μµλ‹λ‹¤. λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λμ–΄ μμ–΄ μΈμ¤ν„΄μ¤ ν•λ‚μ—μ„ μ¥μ• κ°€ λ°μƒν•λ©΄ λ λ””μ¤ μ „μ²΄μ— μ¥μ• κ°€ λ°μƒν•κ² λκΈ° λ•λ¬Έμ…λ‹λ‹¤. 

μ μ΄μ  μ„μ—μ„ κµ¬μƒν• λ°©λ²•μ„ μ‹¤μ λ΅ μ‚¬μ©ν•΄λ³΄λ©΄ μ•„λμ™€ κ°™μµλ‹λ‹¤.

```swift
SET resource_name random_value NX PX 30000
```

`NX` μµμ…μ€ ν‚¤κ°€ μ΅΄μ¬ν•μ§€ μ•λ” κ²½μ°μ—λ§ ν‚¤λ¥Ό μƒμ„±ν•λ‹¤λ” κ²ƒμ„ μλ―Έν•©λ‹λ‹¤. ν‚¤ μƒμ„±μ— μ„±κ³µν• κ²½μ° `OK` μ‘λ‹µμ΄ μ¤κ³  ν‚¤κ°€ μ΄λ―Έ μ΅΄μ¬ν•΄ μ‹¤ν¨ν• κ²½μ° `(nil)` μ‘λ‹µμ΄ μ¤κ² λ©λ‹λ‹¤. λ λ””μ¤λ” μ‹±κΈ€ μ¤λ λ“λ΅ λ™μ‘ν•λ©° λ“¤μ–΄μ¨ λ…λ Ήμ–΄λ“¤μ„ μμ°¨μ μΌλ΅ μ²λ¦¬ν•΄λ‚κ°‘λ‹λ‹¤. μ¦‰, λ…λ Ήμ–΄ ν•λ‚ν•λ‚μ μ‹¤ν–‰μ΄ μ›μμ„±μ„ μ§€λ‹™λ‹λ‹¤. λ”°λΌμ„ ν‚¤μ μ΅΄μ¬ μ—¬λ¶€λ¥Ό ν™•μΈν•κ³  ν‚¤λ¥Ό μƒμ„±ν•λ” μ—°μ‚°μ„ μ›μμ μΌλ΅ μν–‰ν•  μ μμΌλ©° ν‚¤ μƒμ„± μ—¬λ¶€ λν• μ• μ μμµλ‹λ‹¤. ν‚¤ μƒμ„±μ— μ„±κ³µν•΄ `OK` μ‘λ‹µμ΄ μ¤λ©΄ λ½μ„ νλ“ν• κ²ƒμ…λ‹λ‹¤.

`PX` μµμ…μ€ `ms` λ‹¨μ„λ΅ ν‚¤μ λ§λ£ μ‹κ°„μ„ μ„¤μ •ν•λ” κ²ƒμ„ μλ―Έν•©λ‹λ‹¤. `PX 30000` μ€ **30 μ΄** λ’¤μ— ν‚¤κ°€ λ§λ£λμ–΄ μλ™μΌλ΅ μ‚­μ λ¨μ„ μλ―Έν•©λ‹λ‹¤. μ„μ—μ„ λ§ν–λ“―μ΄ λ§λ£ μ‹κ°„μ„ μ„¤μ •ν•¨μΌλ΅μ¨ **Liveness Property A**λ¥Ό λ³΄μ¥ν•  μ μμµλ‹λ‹¤. `PX` λ€μ‹  `EX` μµμ…μ„ μ‚¬μ©ν•΄λ„ λ©λ‹λ‹¤.

`SET` λ…λ Ήμ–΄μ— μ‚¬μ©ν•  μ μλ” μµμ…λ“¤μ€ [κ³µμ‹ λ¬Έμ„](https://redis.io/commands/set)μ—μ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

ν‚¤λ” μμ›μ μ΄λ¦„μ„ μλ―Έν•λ©° λ½μ„ κµ¬λ¶„ν•λ” λ‹¨μ„μ…λ‹λ‹¤. ν‚¤ μ΄λ¦„μ„ λ‹¤λ¥΄κ² ν•¨μΌλ΅μ¨ ν•λ‚μ λ λ””μ¤λ΅ μ—¬λ¬ λ¶„μ‚° λ½μ„ μ‚¬μ©ν•  μλ„ μμµλ‹λ‹¤.

ν‚¤μ— μ €μ¥λλ” κ°’μ€ λ¬΄μ‘μ„ κ°’μ„ κ°€μ§‘λ‹λ‹¤. μ¦‰, λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ μ κΈ μ”μ²­μ—μ„ κ³ μ ν• κ°’μ„ κ°€μ Έμ•Ό ν•©λ‹λ‹¤. μλ¥Ό λ“¤λ©΄ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

* ν΄λΌμ΄μ–ΈνΈ Aκ°€ DB(ν‚¤ μ΄λ¦„)μ— λ€ν• λ½μ„ νλ“ν•©λ‹λ‹¤. μ΄ λ• κ°’μ€ 1λ΅ μ„¤μ •ν•©λ‹λ‹¤.
* ν΄λΌμ΄μ–ΈνΈ Aκ°€ DBμ— λ€ν• μ‘μ—…μ„ λ§λ¬΄λ¦¬ν• λ’¤ ν‚¤λ¥Ό μ‚­μ ν•©λ‹λ‹¤.
* ν΄λΌμ΄μ–ΈνΈ Bκ°€ DBμ— λ€ν• λ½μ„ νλ“ν•©λ‹λ‹¤. μ΄ λ• κ°’μ€ 2λ΅ μ„¤μ •ν•©λ‹λ‹¤.
* ν΄λΌμ΄μ–ΈνΈ Bκ°€ DBμ— λ€ν• μ‘μ—…μ„ λ§λ¬΄λ¦¬ν• λ’¤ ν‚¤λ¥Ό μ‚­μ ν•©λ‹λ‹¤.
* ν΄λΌμ΄μ–ΈνΈ Aκ°€ DBμ— λ€ν• λ½μ„ νλ“ν•©λ‹λ‹¤. μ΄ λ• κ°’μ€ 3λ΅ μ„¤μ •ν•©λ‹λ‹¤.

κ°’μ€ λ¨λ“  μ”μ²­μ— λ€ν•΄μ„ λ¬΄μ‘μ„ κ°’μ„ κ°€μ Έμ•Ό ν•©λ‹λ‹¤. μ •ν™•νλ” λ½μ„ κΈ°λ‹¤λ¦¬κ³  μλ” ν΄λΌμ΄μ–ΈνΈκ°€ μμΈ΅ν•  μ μ—†λ” κ°’μ„ μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤. λ”°λΌμ„ ν΄λΌμ΄μ–ΈνΈλ§λ‹¤ λ‹¤λ¥Έ κ°’μ„ μ‚¬μ©ν•λ” κ²ƒμ€ λ¬Όλ΅ μ΄κ³  κ°™μ€ ν΄λΌμ΄μ–ΈνΈλΌλ„ λ§¤ μ”μ²­λ§λ‹¤ μ„¤μ •ν•λ” κ°’μ΄ λ‹¬λΌμ Έμ•Ό ν•©λ‹λ‹¤.

μ΄λ¬ν• λ¬΄μ‘μ„ κ°’μ„ μ‚¬μ©ν•λ” μ΄μ λ” λ½μ„ νλ“ν• ν΄λΌμ΄μ–ΈνΈλ§μ΄ λ½μ„ λ°λ‚©ν•  μ μκΈ° λ•λ¬Έμ…λ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ νλ“ν•΄ ν‚¤λ¥Ό λ§λ“¤μ—λ‹¤λ©΄ κ·Έ ν΄λΌμ΄μ–ΈνΈκ°€ ν‚¤λ¥Ό μ‚­μ ν•΄μ•Όν•©λ‹λ‹¤. λ½μ„ κΈ°λ‹¤λ¦¬κ³  μλ” λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ μ„μλ΅ ν‚¤λ¥Ό μ‚­μ ν•΄λ²„λ ¤μ„λ” μ•λ©λ‹λ‹¤. λ”°λΌμ„ `Lua` μ¤ν¬λ¦½νΈλ¥Ό μ‚¬μ©ν•΄ λ λ””μ¤μ—κ² μ•„λμ™€ κ°™μ΄ μ”μ²­μ„ λ³΄λƒ„μΌλ΅μ¨ λ½μ„ λ°λ‚©ν•΄μ•Ό μ•μ „ν•κ² λ½μ„ λ‹¤λ£° μ μμµλ‹λ‹¤. `Lua` μ¤ν¬λ¦½νΈμ— λ€ν• μμ„Έν• λ‚΄μ©μ€ [κ³µμ‹ λ¬Έμ„](https://redis.io/commands/eval)μ—μ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

```swift
if redis.call("get", KEYS[1]) == ARGV[1] then
	return redis.call("del", KEYS[1])
else
	return 0
end
```

λ¨Όμ € μ£Όμ–΄μ§„ ν‚¤λ΅ κ°’μ„ κ°€μ Έμµλ‹λ‹¤. λ§μ•½ ν‚¤κ°€ μ΅΄μ¬ν•μ§€ μ•μ•„ `(nil)`μ„ λ°ν™λ°›κ±°λ‚ κ°€μ Έμ¨ κ°’μ΄ `ARGV[1]`κ³Ό μΌμΉν•μ§€ μ•λ” κ²½μ° μ¦‰, ν‚¤κ°€ μ΅΄μ¬ν•μ§€ μ•κ±°λ‚ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ νλ“ν• λ½μ„ λ°λ‚©ν•λ ¤κ³  μ‹λ„ν•λ” κ²½μ° 0μ„ λ°ν™ν•©λ‹λ‹¤. λ§μ•½ ν‚¤κ°€ μ΅΄μ¬ν•κ³  λ‚΄κ°€ νλ“ν–λ λ½μ΄λΌλ©΄ ν‚¤λ¥Ό μ‚­μ ν•κ³  1(μ‚­μ ν• ν‚¤μ κ°μ)λ¥Ό λ°ν™ν•©λ‹λ‹¤.

μ΄λ” `Lua` μ¤ν¬λ¦½νΈλ¥Ό μ‚¬μ©ν•΄ ν‚¤κ°€ μ΅΄μ¬ν•κ³  λ‚΄κ°€ μƒμ„±ν–λ ν‚¤λΌλ©΄ ν‚¤λ¥Ό μ‚­μ ν•λ‹¤λ” λ™μ‘μ„ **μ›μμ **μΌλ΅ μν–‰ν•  μ μμµλ‹λ‹¤.

μ΄λ¥Ό `Ts`λ΅ κµ¬ν„ν•λ©΄ μ•„λμ™€ κ°™μµλ‹λ‹¤.

## Tsλ΅ λ λ””μ¤ λ¶„μ‚°λ½ κµ¬ν„ν•κΈ°

λ¨Όμ € λ λ””μ¤λ΅ λ¶„μ‚° λ½μ„ κ΄€λ¦¬ν•λ” `RedisDLM`μ„ λ§λ“¤μ–΄μ¤λ‹λ‹¤.

```typescript
import {redis} from "./RedisWrapper";
import {v4 as uuidV4} from "uuid";
import {sleep} from "./util";

export class RedisDLM {

    constructor() {
        redis.defineCommand("releaseLock", {
            numberOfKeys: 1,
            lua: `
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
    `
        })
    }
  
    async acquireLock(key: string) {
        while (true) {
            const {identity, success} = await this.tryToAcquireLock(key)
            if (success) {
                return identity
            }
            await sleep(1000); // μ‹¤μ λ΅λ” μ •ν•΄μ§„ μλ§νΌ λ½ νλ“μ„ μ‹λ„ν•κ³  ν¬κΈ°ν•΄μ•Ό ν•©λ‹λ‹¤
        }
    }

    private async tryToAcquireLock(key: string) {
        const identity = uuidV4();
        console.log('call redis for acquire lock')
        const result = await redis.set(key, identity, "PX", 30000, "NX")
        return {
            success: result === 'OK',
            identity
        }
    }

    async releaseLock(key: string, identity: string) {
        console.log('call redis for release lock')
        const numberOfDeletedKey = await redis.releaseLock(key, identity)
        return {
            success: numberOfDeletedKey === 1
        }
    }
}


export const redisDLM = new RedisDLM()

```

`ioredis`μ—μ„λ” μ‚¬μ©μκ°€ μ •μν• μ¤ν¬λ¦½νΈλ¥Ό λ³΄λ‹¤ μ‰½κ² μ‚¬μ©ν•  μ μλ„λ΅ `defineCommand` λ©”μ†λ“λ¥Ό μ κ³µν•©λ‹λ‹¤. λ λ””μ¤μ—μ„ `Lua` μ¤ν¬λ¦½νΈλ¥Ό μ‚¬μ©ν•κΈ° μ„ν•΄μ„ `EVAL` λλ” `EVALSHA` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤. λ‘ λ…λ Ήμ–΄μ μ°¨μ΄λ” λ λ””μ¤μ μ¤ν¬λ¦½νΈ μΊμ‹ μ—¬λ¶€μ— μμµλ‹λ‹¤. λ§¤λ² κΈ΄ μ¤ν¬λ¦½νΈλ¥Ό μ „μ†΅ν•λ” κ²ƒλ³΄λ‹¤ λ„¤νΈμ›ν¬ λ€μ—­ μ κ° ν¨κ³Όλ¥Ό μ–»μ„ μ μμµλ‹λ‹¤.

μ΄μ— `ioredis`λ” κ°λ°μκ°€ λ¨λ“  μ¤ν¬λ¦½νΈμ— λ€ν•΄μ„ μΊμ‹ μ—¬λ¶€λ¥Ό κ²°μ •ν•κ³ , κ·Έμ— λ”°λΌ μ½”λ“λ¥Ό μμ •ν•λ” κ²ƒμ€ λ§¤μ° μ§€λ£¨ν• μΌμ΄λΌλ©° `defineCommand` λ©”μ†λ“λ¥Ό μ κ³µν•΄μ£Όκ³  μμµλ‹λ‹¤.

μ΄ λ• `releaseLock`μ΄λΌλ” λ λ””μ¤ λ…λ Ήμ–΄λ” λ λ””μ¤μ— μ›λ μ΅΄μ¬ν•μ§€ μ•λ”, μ‚¬μ©μκ°€ μ •μν• λ…λ Ήμ–΄μ΄λ―€λ΅ κ·Έλ€λ΅ `Ts` ν™κ²½μ—μ„ μ‚¬μ©ν•  μ μ—†μµλ‹λ‹¤. λ”°λΌμ„ κΉƒν—λΈμ— κ΄€λ ¨ [μ΄μ](https://github.com/luin/ioredis/issues/806#issuecomment-488573878)μ²λΌ μ•„λμ™€ κ°™μ΄ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.

```typescript
import Redis, { Redis as RedisInterface } from 'ioredis';

// @ts-ignore
export const redis: MyRedis = new Redis();

interface MyRedis extends RedisInterface {
    releaseLock(key : string, value : string) : Promise<number>
}

```

λ”°λΌμ„ μ•„λμ™€ κ°™μ΄ λ¶„μ‚° λ½μ„ ν…μ¤νΈν•  μ μμµλ‹λ‹¤. λ λ””μ¤λ” λ΅μ»¬μ— λ„μ›μ„ μ‚¬μ©ν–μΌλ©° κ°™μ€ ν”„λ΅μ„Έμ¤μ—μ„ λ¶„μ‚° λ½μ„ ν…μ¤νΈ ν–μµλ‹λ‹¤.

```typescript
import {redisDLM} from "./RedisDLM";
import {sleep} from "./util";

const procedure = async (clientId: string) => {
    console.log(`[${clientId}] Try to acquire lock`)
    const identity = await redisDLM.acquireLock("DB");
    console.log(`[${clientId}] success lock[${identity}]`)

    console.log(`[${clientId}] Do something`)
    await sleep(5000);


    console.log(`[${clientId}] Try to Release lock[${identity}]`)
    const {success: ReleaseSuccess} = await redisDLM.releaseLock("DB", identity)
    console.log(`[${clientId}] Release lock[${identity}] result : ${ReleaseSuccess}`)
}

procedure("Client A")
    .catch()

setTimeout(() => {

    procedure("Client B")
        .catch()
}, 1500)

```

μ΄λ¥Ό μ‹¤ν–‰ν•΄λ³΄λ©΄ μ•„λμ™€ κ°™λ‹¤. `Client A`κ°€ λ½μ„ λ°λ‚©ν•΄μ•Ό `Client B`κ°€ λ½μ„ νλ“ν•  μ μλ” κ²ƒμ„ μ• μ μλ‹¤.

<img src="images/ecGeBLfX5JKgyO4FE0AJbSXaQ.svg" width="100%" alt=''/>

μ΄λ΅μ¨ κ°„λ‹¨ν•κ² λ λ””μ¤λ¥Ό μ‚¬μ©ν•΄ λ¶„μ‚° λ½μ„ κµ¬ν„ν•  μ μμ—λ‹¤. κµ¬ν„ μμ²΄λ” λ§¤μ° κ°„λ‹¨ν–μ§€λ§ κ°„λ‹¨ν•λ§νΌ 2κ°€μ§€ λ¬Έμ μ μ΄ μ΅΄μ¬ν•λ‹¤.

μ²« λ²μ§Έλ΅ μ—¬λ¬ κ°μ λ λ””μ¤ λ…Έλ“λ¥Ό μ‚¬μ©ν•λ” κ²½μ° μ„ λ°©λ²•μ„ μ‚¬μ©ν•  μ μ—†λ‹¤. μ°μ„  λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤μ λ¬Έμ μ μ€ λ°”λ΅ `κ²°ν•¨ ν—μ©μ„±`μ΄ μ—†λ‹¤λ” κ²ƒμ΄λ‹¤. λ§μ•½ ν•λ‚μ λ λ””μ¤ λ…Έλ“μ— μ¥μ• κ°€ λ°μƒν•λ‹¤λ©΄ λ¨λ“  μ„λΉ„μ¤μ—μ„ λ λ””μ¤ μμ²΄λ¥Ό μ‚¬μ©ν•  μ μ—†κ² λκ³  λ”°λΌμ„ μ „μ‚¬ μ¥μ• λ΅ μ΄μ–΄μ§ κ²ƒμ΄λ‹¤. μ΄λ” μΉλ…μ μΈ λ‹¨μ μ΄κ³  λ”°λΌμ„ μ„λΉ„μ¤μ—μ„ λ¶„μ‚° λ½μ„ μ§€ν‚¤λ” κ²ƒμ΄ λ§¤μ° μ¤‘μ”ν•λ‹¤λ©΄ μ λ€λ΅ λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±ν•΄μ„λ” μ•λλ‹¤. ν•μ§€λ§ `Slave`λ¥Ό μ¶”κ°€ν•΄ λ λ””μ¤ ν΄λ¬μ¤ν„°λ¥Ό μ‚¬μ©ν•΄λ„ μ΄λ¥Ό ν•΄κ²°ν•  μ μ—†λ‹¤.

λ λ””μ¤μ `Master`μ™€ `Slave`λ” λΉ„λ™κΈ°μ μΌλ΅ λ³µμ λλ‹¤. λ”°λΌμ„ μ•„λμ™€ κ°™μ€ μƒν™©μ΄ λ°μƒν•  μ μλ‹¤.

* `Client A`κ°€  `Master`λ΅λ¶€ν„° λ½μ„ νλ“ν•©λ‹λ‹¤.
* `Master`μ— ν‚¤κ°€ μƒμ„±λ©λ‹λ‹¤.
* `Master`μ—μ„ μƒμ„±λ ν‚¤κ°€ `Slave`μ— λ³µμ λκΈ° μ „μ— `Master`μ— μ¥μ• κ°€ λ°μƒν•©λ‹λ‹¤.
* `Slave`λ” `Master`λ΅ μΉκ²©λ©λ‹λ‹¤.
* `Client B`κ°€ λ½μ„ νλ“ν•λ ¤κ³  ν•©λ‹λ‹¤.
* `Master`κ°€ λ μ΄μ „ `Slave` λ…Έλ“μ— ν‚¤κ°€ μ΅΄μ¬ν•μ§€ μ•μΌλ―€λ΅ `Client B`λ” λ½μ„ νλ“ν•κ³  `Slave` λ…Έλ“λ” ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
* μ¦‰, `Client A`μ™€ `Client B` λ¨λ‘ λ½μ„ νλ“ν• μƒνƒκ°€ λ©λ‹λ‹¤.

μ¦‰, μ—¬λ¬ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤μ— λ€ν•΄μ„ `Safety Property`μ **μƒνΈ λ°°μ μ„±**μ„ λ³΄μ¥ν•  μ μ—†μµλ‹λ‹¤.

λ”°λΌμ„ λ¶„μ‚° λ½μ **μƒνΈ λ°°μ¬μ„±**μ„ μ§€ν‚¤λ” κ²ƒμ΄ μ•„μ£Ό μ¤‘μ”ν• μ„λΉ„μ¤λΌλ©΄ μ„μ™€ κ°™μ€ λ°©λ²•μ„ μ‚¬μ©ν•  μ μ—†μµλ‹λ‹¤. μƒνΈ λ°°μ μ„±μ„ λ³΄μ¥ν•κΈ° μ„ν•΄ λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤λ¥Ό μ‚¬μ©ν•  μ μ—†κΈ° λ•λ¬Έμ…λ‹λ‹¤. ν•μ§€λ§ κ°€λ” **μƒνΈ λ°°μ μ„±**μ΄ <u>μ–΄κ²¨μ§€λ”</u> κ²ƒμ΄ κ΄μ°®μ€ μ„λΉ„μ¤λΌλ©΄ μ„μ—μ„ μ΄μ•ΌκΈ° ν• μ†”λ£¨μ…μ„ μ‚¬μ©ν•λ” κ²ƒλ„ κ΄μ°®μ€ μ„ νƒμΌ μλ„ μμµλ‹λ‹¤. κ°„λ‹¨ν•κ³  ν¨μ¨μ μ΄κΈ° λ•λ¬Έμ…λ‹λ‹¤.

λ‘ λ²μ§Έ λ¬Έμ λ” λ½μ„ κΈ°λ‹¤λ¦¬λ” κ³Όμ •μ΄ λΉ„ν¨μ¨μ μ΄λΌλ” κ²ƒμ…λ‹λ‹¤. λ½μ„ νλ“ν•κΈ° μ„ν•΄μ„ κΈ°λ‹¤λ¦¬λ” κ³Όμ •μ΄ `spinlock`κ³Ό μ μ‚¬ν•κΈ° λ•λ¬Έμ…λ‹λ‹¤.

μ„μ—μ„ μ§„ν–‰ν• ν…μ¤νΈμ—μ„ μ• μ μλ“―μ΄ `Client B`λ” λ½μ„ νλ“ν•κΈ° μ„ν•΄ **1μ΄**λ§λ‹¤ λ λ””μ¤μ—κ² μ”μ²­μ„ ν•©λ‹λ‹¤. λ§μ•½ 1μ΄ κ±Έλ¦¬λ” μ”μ²­μ— λ€ν•΄ **50ms**λ§λ‹¤ μ§μλ¥Ό ν•  λ• μ”μ²­μ΄ 100κ°κ°€ λ™μ‹μ— λ“¤μ–΄μ™”λ‹¤λ©΄ κ±°μ 10,000λ² λ λ””μ¤μ—κ² μ”μ²­μ„ ν•κ² λ©λ‹λ‹¤. μ΄λ” ν•λ‚ν•λ‚ λ…λ Ήμ–΄λ¥Ό μ²λ¦¬ν•λ” λ λ””μ¤ νΉμ„± μƒ μ—„μ²­λ‚ λ¶€ν•κ°€ λ  μλ„ μμµλ‹λ‹¤. μ΄λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ μ§μ κ°„κ²©μ„ μ¤„μ΄κ² λλ‹¤λ©΄ κ·Έλ§νΌ μ”μ²­μ— λ€ν• μ²λ¦¬ μ‹κ°„λ„ κΈΈμ–΄μ§€κ³  λ€κΈ° μ‹κ°„λ„ κΈΈμ–΄μ§€κ² λ©λ‹λ‹¤. μλ°”μ λ λ””μ¤ ν΄λΌμ΄μ–ΈνΈμΈ [Redisson](https://github.com/redisson/redisson/)μ€ `pubsub` κΈ°λ¥μ„ ν™μ©ν•΄ λ½μ„ λ°λ‚©ν•  λ• κΈ°λ‹¤λ¦¬κ³  μλ” ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μ•λ¦ΌμΌλ΅μ¨ λ λ””μ¤ λ¶€ν•λ¥Ό μ—„μ²­λ‚κ² μ¤„μΌ μ μμ—μµλ‹λ‹¤.

## κ²°λ΅ 

μ§€κΈκΉμ§€ λ‹¨μΌ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤μ—μ„μ λ¶„μ‚° λ½ κµ¬ν„μ— λ€ν•΄ μ•μ•„λ³΄μ•μµλ‹λ‹¤. λΉ„λ΅ μ—¬λ¬ κ°μ μΈμ¤ν„΄μ¤λ΅ κµ¬μ„±λ λ λ””μ¤ ν΄λ¬μ¤ν„°μ—μ„ μ‚¬μ©ν•  μ μ—†κ³  λΉ„ν¨μ¨μ μΈ λ©΄μ€ μμ§€λ§ κ·Έλ§νΌ κ°„λ‹¨ν•κ³  κµ¬ν„μ΄ κ°„νΈν•΄ μ™„λ²½ν• μ •ν•©μ„±μ΄ ν•„μ”ν• μ„λΉ„μ¤κ°€ μ•„λ‹λΌλ©΄ κ³ λ ¤ν•΄λ³Ό λ§ν• λ°©λ²•μ΄λΌκ³  μƒκ°ν•©λ‹λ‹¤. λ§μ•½ μ¥μ•  λ€μ‘μ„ μ„ν•΄ μ—¬λ¬ κ°μ λ λ””μ¤λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•λ‹¤λ©΄ κ³µμ‹ λ¬Έμ„μ—μ„ μ†κ°ν•λ” [Redlock](https://redis.io/topics/distlock#the-redlock-algorithm)μ„ μ½μ–΄λ³΄κ±°λ‚ μ΄λ¥Ό κµ¬ν„ν• λΌμ΄λΈλ¬λ¦¬λ¥Ό μ°Ύμ•„λ³΄λ©΄ λ  κ±°λ΅ μƒκ°ν•©λ‹λ‹¤.

```toc
```
